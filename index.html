<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tele Browser</title>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #3b82f6;
      --secondary-color: #06b6d4;
      --accent-color: #22d3ee;
      --dark-bg: #0f172a;
      --medium-bg: #1e293b;
      --light-bg: #334155;
      --text-color: #f8fafc;
      --muted-text: #94a3b8;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
      --box-shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.2);
      --glow-effect: 0 0 15px rgba(34, 211, 238, 0.4);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--dark-bg);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.1) 0%, transparent 30%),
        radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 30%);
      overscroll-behavior: none;
    }

    @supports (font-variation-settings: normal) {
      body {
        font-family: 'Inter var', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
      padding: 0 20px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0;
      padding: 20px 0 10px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
      position: relative;
      display: inline-block;
    }

    h1::after {
      content: "";
      display: block;
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      margin: 12px auto 0;
      border-radius: 2px;
    }

    .status {
      display: inline-flex;
      align-items: center;
      margin: 16px 0;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .status::before {
      content: "";
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .connected {
      background-color: rgba(6, 182, 212, 0.15);
      color: var(--accent-color);
      border: 1px solid rgba(6, 182, 212, 0.3);
      box-shadow: var(--glow-effect);
    }

    .connected::before {
      background-color: var(--accent-color);
      box-shadow: 0 0 10px var(--accent-color);
    }

    .disconnected {
      background-color: rgba(239, 68, 68, 0.15);
      color: var(--error-color);
      border: 1px solid rgba(239, 68, 68, 0.3);
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
    }

    .disconnected::before {
      background-color: var(--error-color);
      box-shadow: 0 0 10px var(--error-color);
    }

    /* 控制面板样式 */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin: 20px 0;
      padding: 20px;
      background-color: rgba(30, 41, 59, 0.7);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow-sm);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    button {
      padding: 10px 18px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
      box-shadow: var(--glow-effect);
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--light-bg);
      box-shadow: none;
      transform: none !important;
    }

    select {
      padding: 10px 14px;
      background-color: var(--light-bg);
      color: var(--text-color);
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      outline: none;
      transition: var(--transition);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    select:hover {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
    }

    /* 浏览器容器样式 */
    .browser-container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      border-radius: var(--border-radius);
      overflow: hidden;
      background-color: var(--medium-bg);
      box-shadow: var(--box-shadow);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* 导航栏样式 */
    .nav-bar {
      display: flex;
      width: 100%;
      background: linear-gradient(90deg, #1a1a1a, #2c2c2c);
      color: white;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      overflow: hidden;
      border-bottom: 1px solid rgba(34, 211, 238, 0.2);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .nav-btn {
      background-color: transparent;
      color: white;
      border: none;
      padding: 14px 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
    }

    .nav-btn:hover,
    .nav-btn:focus {
      background-color: rgba(34, 211, 238, 0.1);
    }

    .nav-btn:disabled {
      color: var(--muted-text);
      cursor: not-allowed;
      background-color: transparent;
    }

    .url-bar {
      flex-grow: 1;
      padding: 12px 16px;
      border: none;
      outline: none;
      background-color: rgba(15, 23, 42, 0.8);
      color: white;
      font-size: 14px;
      border-radius: var(--border-radius-sm);
      margin: 8px;
      transition: var(--transition);
      font-family: inherit;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .url-bar:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
    }

    /* 远程显示画布样式 */
    #remoteDisplay {
      width: 100%;
      height: auto;
      border: none;
      background-color: #000;
      display: block;
      aspect-ratio: 16/9;
    }

    /* 调试信息区域 */
    #debugInfo {
      margin-top: 24px;
      font-family: 'Roboto Mono', 'Consolas', monospace;
      background-color: rgba(30, 41, 59, 0.7);
      color: var(--muted-text);
      padding: 16px;
      border-radius: var(--border-radius);
      font-size: 13px;
      height: 200px;
      overflow-y: auto;
      box-shadow: var(--box-shadow-sm);
      border-left: 4px solid var(--primary-color);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    #debugInfo div {
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      word-break: break-word;
    }

    /* 状态指示器 */
    .status-indicators {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }

    .indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-color);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 0.5;
        transform: scale(0.8);
      }

      50% {
        opacity: 1;
        transform: scale(1.1);
      }

      100% {
        opacity: 0.5;
        transform: scale(0.8);
      }
    }

    /* 会话信息显示 */
    .session-info {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 211, 238, 0.2);
      color: var(--text-color);
      padding: 10px 16px;
      border-radius: var(--border-radius);
      font-family: 'Roboto Mono', 'Consolas', monospace;
      font-size: 13px;
      z-index: 1000;
      box-shadow: var(--box-shadow-sm);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .session-info::before {
      content: "";
      display: block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-color);
    }

    /* 性能面板 */
    .stats-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 211, 238, 0.2);
      color: var(--text-color);
      padding: 16px;
      border-radius: var(--border-radius);
      font-family: 'Roboto Mono', 'Consolas', monospace;
      font-size: 13px;
      z-index: 1000;
      box-shadow: var(--box-shadow-sm);
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 200px;
    }

    .stats-panel div {
      display: flex;
      justify-content: space-between;
    }

    .stats-panel span:last-child {
      font-weight: 600;
      color: var(--accent-color);
    }

    /* 键盘状态显示 */
    .keyboard-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 211, 238, 0.2);
      color: var(--text-color);
      padding: 10px 16px;
      border-radius: var(--border-radius);
      font-family: 'Roboto Mono', 'Consolas', monospace;
      font-size: 13px;
      z-index: 1000;
      box-shadow: var(--box-shadow-sm);
      display: none;
    }

    /* 加载动画 */
    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: rgba(34, 211, 238, 0.2);
      z-index: 9999;
      overflow: hidden;
    }

    .loader::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      animation: loading 2s infinite ease-in-out;
    }

    @keyframes loading {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(200%);
      }
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      h1 {
        font-size: 1.8rem;
        padding: 16px 0 8px;
      }

      h1::after {
        width: 60px;
        height: 3px;
        margin: 8px auto 0;
      }

      .controls {
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 16px 12px;
        justify-content: flex-start;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }

      .controls::-webkit-scrollbar {
        display: none;
      }

      button,
      select {
        padding: 8px 12px;
        font-size: 13px;
        white-space: nowrap;
      }

      .nav-bar {
        flex-wrap: wrap;
      }

      .nav-btn {
        padding: 10px;
        min-width: 40px;
        font-size: 14px;
      }

      .url-bar {
        order: -1;
        flex: 1 0 100%;
        margin: 8px;
        font-size: 13px;
      }

      #debugInfo {
        font-size: 12px;
        height: 150px;
        padding: 12px;
      }

      .session-info,
      .stats-panel {
        top: 10px;
        left: 10px;
        right: auto;
        font-size: 12px;
        padding: 8px 12px;
      }

      .stats-panel {
        left: 10px;
        right: 10px;
        width: auto;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }

      .status {
        padding: 8px 16px;
        font-size: 14px;
      }

      .controls {
        gap: 8px;
      }

      .nav-btn {
        padding: 8px;
        min-width: 36px;
      }
    }

    /* 防止移动端缩放 */
    @media (pointer: coarse) {
      body {
        touch-action: manipulation;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&display=swap"
    rel="stylesheet">
</head>

<body>
  <!-- 加载动画 -->
  <div class="loader"></div>

  <div class="container">
    <header>
      <h1>Tele Browser</h1>
      <div id="statusBox" class="status disconnected">等待连接...</div>
    </header>

    <!-- 控制面板 -->
    <div class="controls">
      <select id="qualitySelector">
        <option value="high">高质量</option>
        <option value="medium" selected>中等质量</option>
        <option value="low">低质量 (高帧率)</option>
      </select>
      <button id="toggleSmooth">启用平滑模式</button>
      <button id="refreshConnBtn">刷新连接</button>
      <button id="statsPanelBtn">性能面板</button>
      <button id="mouseControlBtn">启用鼠标控制</button>
    </div>

    <!-- 浏览器容器 -->
    <div class="browser-container">
      <div class="nav-bar">
        <button id="backBtn" class="nav-btn" title="后退" disabled>←</button>
        <button id="forwardBtn" class="nav-btn" title="前进" disabled>→</button>
        <button id="refreshBtn" class="nav-btn" title="刷新">↻</button>
        <input type="text" id="urlBar" class="url-bar" placeholder="输入网址..." />
        <button id="goBtn" class="nav-btn" title="前往">Go</button>
      </div>
      <canvas id="remoteDisplay"></canvas>
      <div class="status-indicators">
        <div class="indicator"></div>
      </div>
    </div>

    <div id="debugInfo"></div>
  </div>

  <!-- 性能面板 -->
  <div class="stats-panel">
    <div><span>当前FPS:</span> <span id="currentFps">0</span></div>
    <div><span>平均FPS:</span> <span id="avgFps">0</span></div>
    <div><span>帧队列:</span> <span id="frameQueue">0</span></div>
    <div><span>帧延迟:</span> <span id="frameDelay">0ms</span></div>
    <div><span>接收帧数:</span> <span id="receivedFrames">0</span></div>
  </div>

  <!-- 键盘状态显示 -->
  <div class="keyboard-status"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 隐藏加载动画
      setTimeout(() => {
        document.querySelector('.loader').style.opacity = '0';
        setTimeout(() => {
          document.querySelector('.loader').remove();
        }, 300);
      }, 500);

      const canvas = document.getElementById('remoteDisplay');
      const ctx = canvas.getContext('2d', { alpha: false });
      const statusBox = document.getElementById('statusBox');
      const debugInfo = document.getElementById('debugInfo');
      const qualitySelector = document.getElementById('qualitySelector');
      const toggleSmoothBtn = document.getElementById('toggleSmooth');
      const refreshConnBtn = document.getElementById('refreshConnBtn');
      const statsPanelBtn = document.getElementById('statsPanelBtn');
      const mouseControlBtn = document.getElementById('mouseControlBtn');
      const statsPanel = document.querySelector('.stats-panel');
      const keyboardStatus = document.querySelector('.keyboard-status');

      // 性能监控元素
      const currentFpsEl = document.getElementById('currentFps');
      const avgFpsEl = document.getElementById('avgFps');
      const frameQueueEl = document.getElementById('frameQueue');
      const frameDelayEl = document.getElementById('frameDelay');
      const receivedFramesEl = document.getElementById('receivedFrames');

      let lastUpdateTime = 0;
      let frameCount = 0;
      let fps = 0;
      let receivedFrames = 0;
      let lastFrameTimestamp = 0;
      let smooth = false;
      let skipFrames = false;
      let frameQueue = [];
      let imageQuality = 'medium';
      let mouseControlEnabled = false;
      let currentMetadata = null;
      let ws;
      let animationFrameId = null;
      let fpsHistory = [];
      const maxHistory = 60;

      // 初始化画布尺寸
      canvas.width = 1280;
      canvas.height = 720;

      // 移动设备自动设置为低质量
      if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        qualitySelector.value = 'low';
        imageQuality = 'low';
        skipFrames = true;
        log('检测到移动设备，已自动设置为低质量模式');
      }

      // 平滑渲染切换
      toggleSmoothBtn.addEventListener('click', () => {
        smooth = !smooth;
        ctx.imageSmoothingEnabled = smooth;
        ctx.imageSmoothingQuality = 'high';
        toggleSmoothBtn.textContent = smooth ? '禁用平滑模式' : '启用平滑模式';
        log(smooth ? '已启用平滑模式' : '已禁用平滑模式');
      });

      // 图像质量设置
      qualitySelector.addEventListener('change', () => {
        imageQuality = qualitySelector.value;
        skipFrames = (imageQuality === 'low');
        frameQueue = [];
        log(`已切换到${qualitySelector.options[qualitySelector.selectedIndex].text}`);
      });

      // 绘制帧函数
      function drawFrame() {
        try {
          if (frameQueue.length > 0) {
            if (skipFrames && frameQueue.length > 1) {
              const latestFrame = frameQueue.pop();
              frameQueue = [latestFrame];
            }

            const frame = frameQueue.shift();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            try {
              ctx.drawImage(frame.img, 0, 0, canvas.width, canvas.height);

              // 计算FPS
              const now = performance.now();
              frameCount++;

              if (now - lastUpdateTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (now - lastUpdateTime));
                frameCount = 0;
                lastUpdateTime = now;
                updateStatus(`已连接 - ${fps} FPS`, true);
              }

              // 显示时间戳和FPS
              ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
              ctx.fillRect(5, 5, 200, 20);
              ctx.fillStyle = "white";
              ctx.font = "12px 'Roboto Mono', monospace";
              const now2 = new Date();
              ctx.fillText(`${now2.toLocaleTimeString()} - FPS: ${fps} - 队列: ${frameQueue.length}`, 10, 18);
            } catch (drawError) {
              log(`绘制图像出错: ${drawError.message}`);
            }
          }
        } catch (error) {
          log(`动画帧处理错误: ${error.message}`);
        }

        animationFrameId = requestAnimationFrame(drawFrame);
      }

      // 启动动画循环
      animationFrameId = requestAnimationFrame(drawFrame);

      // WebSocket连接
      function connectWebSocket() {
        let wsUrl = "wss://1300423047-1r5ptj10hp.ap-guangzhou.tencentscf.com";

        ws = new WebSocket(wsUrl);
        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
          log('WebSocket已连接');
          updateStatus('已连接到服务器，等待图像...', true);
        };

        ws.onclose = () => {
          log('WebSocket已断开');
          updateStatus('服务器连接已断开', false);
          tryReconnect();
        };

        ws.onerror = (error) => {
          log(`WebSocket错误: ${error.message}`);
        };

        ws.onmessage = handleWebSocketMessage;

        return ws;
      }

      // 处理WebSocket消息
      function handleWebSocketMessage(event) {
        try {
          if (event.data instanceof ArrayBuffer) {
            // 处理二进制图像数据
            receivedFrames++;

            if (!currentMetadata) {
              log('收到图像数据但没有元数据，忽略...');
              return;
            }

            const blob = new Blob([event.data], { type: 'image/jpeg' });
            const timestamp = currentMetadata.timestamp || Date.now();

            if (skipFrames && lastFrameTimestamp > 0 && timestamp - lastFrameTimestamp < 50) {
              return;
            }

            lastFrameTimestamp = timestamp;

            // 调整画布尺寸
            if (canvas.width !== currentMetadata.width || canvas.height !== currentMetadata.height) {
              log(`调整画布尺寸: ${currentMetadata.width}x${currentMetadata.height}`);
              canvas.width = currentMetadata.width;
              canvas.height = currentMetadata.height;
            }

            const url = URL.createObjectURL(blob);
            const img = new Image();

            img.onload = () => {
              frameQueue.push({ img, timestamp });
              if (frameQueue.length > 5) frameQueue.shift();
              URL.revokeObjectURL(url);
            };

            img.onerror = (err) => {
              log(`图像加载错误: ${err}`);
              URL.revokeObjectURL(url);
            };

            img.src = url;
          } else {
            // 处理文本消息
            const message = JSON.parse(event.data);

            if (message.type === 'metadata') {
              currentMetadata = {
                width: message.width,
                height: message.height,
                timestamp: message.timestamp
              };
            } else if (message.type === 'ping') {
              ws.send(JSON.stringify({ type: 'pong', time: Date.now() }));
            } else if (message.type === 'navigation') {
              handleNavigationResponse(message);
            } else if (message.type === 'session') {
              updateSessionInfo(message.clientId);
            }
          }
        } catch (error) {
          log(`处理消息时出错: ${error.message}`);
        }
      }

      // 更新状态显示
      function updateStatus(message, connected = null) {
        statusBox.textContent = message;
        if (connected === true) {
          statusBox.classList.remove('disconnected');
          statusBox.classList.add('connected');
        } else if (connected === false) {
          statusBox.classList.remove('connected');
          statusBox.classList.add('disconnected');
        }
      }

      // 自动重连功能
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5;
      let reconnectTimer = null;

      function tryReconnect() {
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          log(`尝试重新连接 (${reconnectAttempts}/${maxReconnectAttempts})...`);
          updateStatus(`正在重新连接 (${reconnectAttempts}/${maxReconnectAttempts})...`, false);

          clearTimeout(reconnectTimer);
          reconnectTimer = setTimeout(() => {
            ws = connectWebSocket();
          }, 2000 * reconnectAttempts);
        } else {
          log('达到最大重连次数，请手动刷新页面');
          updateStatus('连接失败，请刷新页面重试', false);
        }
      }

      // 手动刷新连接
      refreshConnBtn.addEventListener('click', () => {
        log('手动刷新连接...');
        reconnectAttempts = 0;
        clearTimeout(reconnectTimer);
        if (ws) ws.close();
        ws = connectWebSocket();
      });

      // 性能面板切换
      statsPanelBtn.addEventListener('click', () => {
        statsPanel.style.display = statsPanel.style.display === 'none' ? 'flex' : 'none';
        statsPanelBtn.textContent = statsPanel.style.display === 'none' ? '性能面板' : '隐藏面板';
      });

      // 更新性能面板
      function updateStatsPanel() {
        if (statsPanel.style.display === 'none') return;

        const avgFps = fpsHistory.length > 0
          ? Math.round(fpsHistory.reduce((a, b) => a + b, 0) / fpsHistory.length)
          : 0;

        const frameDelay = frameQueue.length > 0
          ? Math.round(performance.now() - frameQueue[0].timestamp)
          : 0;

        currentFpsEl.textContent = fps;
        avgFpsEl.textContent = avgFps;
        frameQueueEl.textContent = frameQueue.length;
        frameDelayEl.textContent = `${frameDelay}ms`;
        receivedFramesEl.textContent = receivedFrames;
      }

      // 定期更新性能数据
      setInterval(() => {
        fpsHistory.push(fps);
        if (fpsHistory.length > maxHistory) fpsHistory.shift();
        updateStatsPanel();
      }, 1000);

      // 鼠标控制功能
      function setupMouseControl() {
        let isMouseDown = false;

        // 鼠标移动
        canvas.addEventListener('mousemove', handleMouseMove);

        // 鼠标按下
        canvas.addEventListener('mousedown', handleMouseDown);

        // 鼠标释放
        canvas.addEventListener('mouseup', handleMouseUp);

        // 鼠标点击
        canvas.addEventListener('click', handleMouseClick);

        // 右键菜单
        canvas.addEventListener('contextmenu', handleContextMenu);

        // 双击
        canvas.addEventListener('dblclick', handleDoubleClick);

        // 滚轮
        canvas.addEventListener('wheel', handleWheel, { passive: false });

        // 防止滚动和选中
        canvas.style.touchAction = 'none';
        canvas.style.userSelect = 'none';
        canvas.style.cursor = 'crosshair';

        log('鼠标控制已启用');
      }

      // 鼠标事件处理函数
      function handleMouseMove(e) {
        if (ws.readyState === WebSocket.OPEN) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          ws.send(JSON.stringify({
            type: 'mouse',
            action: 'move',
            x: x,
            y: y,
            button: e.buttons,
            timestamp: Date.now()
          }));
        }
      }

      function handleMouseDown(e) {
        if (ws.readyState === WebSocket.OPEN) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          ws.send(JSON.stringify({
            type: 'mouse',
            action: 'down',
            x: x,
            y: y,
            button: e.button,
            timestamp: Date.now()
          }));

          e.preventDefault();
        }
      }

      function handleMouseUp(e) {
        if (ws.readyState === WebSocket.OPEN) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          ws.send(JSON.stringify({
            type: 'mouse',
            action: 'up',
            x: x,
            y: y,
            button: e.button,
            timestamp: Date.now()
          }));

          e.preventDefault();
        }
      }

      function handleMouseClick(e) {
        if (ws.readyState === WebSocket.OPEN) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          ws.send(JSON.stringify({
            type: 'mouse',
            action: 'click',
            x: x,
            y: y,
            button: e.button,
            timestamp: Date.now()
          }));

          e.preventDefault();
        }
      }

      function handleContextMenu(e) {
        if (ws.readyState === WebSocket.OPEN) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          ws.send(JSON.stringify({
            type: 'mouse',
            action: 'contextmenu',
            x: x,
            y: y,
            timestamp: Date.now()
          }));

          e.preventDefault();
        }
      }

      function handleDoubleClick(e) {
        if (ws.readyState === WebSocket.OPEN) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          ws.send(JSON.stringify({
            type: 'mouse',
            action: 'dblclick',
            x: x,
            y: y,
            button: e.button,
            timestamp: Date.now()
          }));

          e.preventDefault();
        }
      }

      function handleWheel(e) {
        if (ws.readyState === WebSocket.OPEN) {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          ws.send(JSON.stringify({
            type: 'mouse',
            action: 'wheel',
            x: x,
            y: y,
            deltaX: e.deltaX,
            deltaY: e.deltaY,
            timestamp: Date.now()
          }));

          e.preventDefault();
        }
      }

      // 移除鼠标控制
      function removeMouseControl() {
        canvas.removeEventListener('mousemove', handleMouseMove);
        canvas.removeEventListener('mousedown', handleMouseDown);
        canvas.removeEventListener('mouseup', handleMouseUp);
        canvas.removeEventListener('click', handleMouseClick);
        canvas.removeEventListener('contextmenu', handleContextMenu);
        canvas.removeEventListener('dblclick', handleDoubleClick);
        canvas.removeEventListener('wheel', handleWheel);

        canvas.style.cursor = 'default';
      }

      // 鼠标控制按钮
      mouseControlBtn.addEventListener('click', () => {
        mouseControlEnabled = !mouseControlEnabled;

        if (mouseControlEnabled) {
          setupMouseControl();
          mouseControlBtn.textContent = '禁用鼠标控制';
        } else {
          removeMouseControl();
          mouseControlBtn.textContent = '启用鼠标控制';
          log('鼠标控制已禁用');
        }
      });

      // 键盘控制
      function setupKeyboardControl() {
        const pressedKeys = new Set();
        const lastKeyEvents = {};
        const MIN_EVENT_INTERVAL = 50;

        // 键盘按下
        document.addEventListener('keydown', (e) => {
          if (ws.readyState !== WebSocket.OPEN || document.activeElement.tagName === 'INPUT') return;
          if (pressedKeys.has(e.code)) {
            if (['F5', 'F11', 'F12'].includes(e.key) ||
              (e.ctrlKey && ['r', 's', 'p', 'o', 'n'].includes(e.key.toLowerCase()))) {
              e.preventDefault();
            }
            return;
          }

          const now = Date.now();
          if (lastKeyEvents[e.code] && now - lastKeyEvents[e.code] < MIN_EVENT_INTERVAL) {
            e.preventDefault();
            return;
          }

          pressedKeys.add(e.code);
          lastKeyEvents[e.code] = now;

          ws.send(JSON.stringify({
            type: 'keyboard',
            action: 'down',
            key: e.key,
            code: e.code,
            altKey: e.altKey,
            ctrlKey: e.ctrlKey,
            shiftKey: e.shiftKey,
            metaKey: e.metaKey,
            timestamp: now
          }));

          // 显示按键状态
          if (!/^(Alt|Control|Shift|Meta|OS)/.test(e.code)) {
            keyboardStatus.textContent = `按键: ${e.key} (${e.code})`;
            keyboardStatus.style.display = 'block';
            setTimeout(() => {
              keyboardStatus.style.display = 'none';
            }, 3000);
          }

          if (['F5', 'F11', 'F12'].includes(e.key) ||
            (e.ctrlKey && ['r', 's', 'p', 'o', 'n'].includes(e.key.toLowerCase()))) {
            e.preventDefault();
          }
        }, { passive: false });

        // 键盘释放
        document.addEventListener('keyup', (e) => {
          if (ws.readyState !== WebSocket.OPEN || document.activeElement.tagName === 'INPUT') return;
          pressedKeys.delete(e.code);
          ws.send(JSON.stringify({
            type: 'keyboard',
            action: 'up',
            key: e.key,
            code: e.code,
            altKey: e.altKey,
            ctrlKey: e.ctrlKey,
            shiftKey: e.shiftKey,
            metaKey: e.metaKey,
            timestamp: Date.now()
          }));
        }, { passive: false });

        // 窗口失去焦点时清除按键状态
        window.addEventListener('blur', () => {
          pressedKeys.clear();
        });

        log('键盘控制已启用');
      }

      // 自动启用键盘控制
      setupKeyboardControl();

      // 导航功能
      const backBtn = document.getElementById('backBtn');
      const forwardBtn = document.getElementById('forwardBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const urlBar = document.getElementById('urlBar');
      const goBtn = document.getElementById('goBtn');
      let currentUrl = '';

      backBtn.addEventListener('click', () => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'navigation', action: 'back' }));
        }
      });

      forwardBtn.addEventListener('click', () => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'navigation', action: 'forward' }));
        }
      });

      refreshBtn.addEventListener('click', () => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'navigation', action: 'refresh' }));
        }
      });

      urlBar.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') navigateToUrl();
      });

      goBtn.addEventListener('click', navigateToUrl);

      function navigateToUrl() {
        const url = urlBar.value.trim();
        if (url && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'navigation', action: 'goto', url: url }));
        }
      }

      function handleNavigationResponse(data) {
        if (data.error) {
          log(`导航错误: ${data.error}`);
          return;
        }

        currentUrl = data.url;
        urlBar.value = currentUrl;
        backBtn.disabled = !data.canGoBack;
        forwardBtn.disabled = !data.canGoForward;
        log(`导航到: ${currentUrl}`);
      }

      // 会话信息
      let sessionId = null;

      function updateSessionInfo(id) {
        sessionId = id;
        document.title = `远程浏览器 - 会话 ${id.substring(0, 8)}`;

        const sessionInfo = document.createElement('div');
        sessionInfo.className = 'session-info';
        sessionInfo.textContent = `会话ID: ${id.substring(0, 8)}`;
        document.body.appendChild(sessionInfo);

        log(`已分配会话ID: ${id}`);
      }

      // 调试日志
      function log(message) {
        console.log(message);
        const now = new Date();
        const timeStr = now.toISOString().substr(11, 8);
        debugInfo.innerHTML += `<div>${timeStr}: ${message}</div>`;

        // 自动滚动到底部
        debugInfo.scrollTop = debugInfo.scrollHeight;

        // 限制日志条数
        if (debugInfo.children.length > 20) {
          debugInfo.removeChild(debugInfo.children[0]);
        }
      }

      // 心跳检测
      setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
          try {
            ws.send(JSON.stringify({ type: 'ping', time: Date.now() }));
          } catch (e) {
            log(`发送心跳失败: ${e.message}`);
          }
        }
      }, 15000);

      // 页面关闭时清理
      window.addEventListener('beforeunload', () => {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        if (ws) ws.close();
      });

      // 初始连接
      ws = connectWebSocket();
    });
  </script>
</body>

</html>